{"version":3,"file":"wasmWorker-CufBWG-7.js","sources":["../src/pow/wasmWorker.ts"],"sourcesContent":["/**\n * PoW WASM Worker\n * 使用 Rust 编译的 WebAssembly 进行高性能计算\n */\n\nlet initialized = false\nlet workerId = 0\nlet wasmModule: any = null\n\n// 获取WASM路径\nfunction getWasmPath(basePath?: string): string {\n  // 优先级: 参数 > 全局变量 > 自动检测\n  const base = basePath ||\n    (typeof self !== 'undefined' && (self as any).HV_BASE_PATH) ||\n    ''\n\n  // 确保路径以 / 结尾\n  const normalizedBase = base ? (base.endsWith('/') ? base : base + '/') : ''\n\n  return `${normalizedBase}pow_wasm_bg.wasm`\n}\n\n// 初始化 WASM\nasync function initWasm(basePath?: string): Promise<boolean> {\n  if (initialized) return true\n\n  try {\n    // 动态导入WASM模块JS部分\n    const wasmModuleJs = await import('../../pow-wasm/pkg/pow_wasm.js')\n    wasmModule = wasmModuleJs\n\n    // 获取WASM文件路径\n    const wasmPath = getWasmPath(basePath)\n    console.log(`[Worker ${workerId}] 加载WASM: ${wasmPath}`)\n\n    // 初始化WASM(提供WASM文件URL)\n    await wasmModuleJs.default(wasmPath)\n\n    initialized = true\n    console.log(`[Worker ${workerId}] WASM 初始化成功:`, wasmModuleJs.get_version())\n    return true\n  } catch (e) {\n    console.error(`[Worker ${workerId}] WASM 初始化失败:`, e)\n    return false\n  }\n}\n\n// JS 回退版本的 SHA-256\nconst K = new Uint32Array([\n  0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,\n  0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,\n  0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,\n  0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,\n  0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,\n  0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,\n  0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,\n  0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2\n])\n\nfunction sha256JS(str: string): string {\n  const utf8 = new TextEncoder().encode(str)\n  const len = utf8.length\n  const padLen = (len % 64 < 56) ? (56 - len % 64) : (120 - len % 64)\n  const totalLen = len + padLen + 8\n  const msg = new Uint8Array(totalLen)\n  msg.set(utf8)\n  msg[len] = 0x80\n  const view = new DataView(msg.buffer)\n  view.setUint32(totalLen - 4, len * 8, false)\n\n  let h0 = 0x6a09e667, h1 = 0xbb67ae85, h2 = 0x3c6ef372, h3 = 0xa54ff53a\n  let h4 = 0x510e527f, h5 = 0x9b05688c, h6 = 0x1f83d9ab, h7 = 0x5be0cd19\n  const w = new Uint32Array(64)\n\n  for (let i = 0; i < totalLen; i += 64) {\n    for (let j = 0; j < 16; j++) w[j] = view.getUint32(i + j * 4, false)\n    for (let j = 16; j < 64; j++) {\n      const s0 = ((w[j - 15] >>> 7) | (w[j - 15] << 25)) ^ ((w[j - 15] >>> 18) | (w[j - 15] << 14)) ^ (w[j - 15] >>> 3)\n      const s1 = ((w[j - 2] >>> 17) | (w[j - 2] << 15)) ^ ((w[j - 2] >>> 19) | (w[j - 2] << 13)) ^ (w[j - 2] >>> 10)\n      w[j] = (w[j - 16] + s0 + w[j - 7] + s1) >>> 0\n    }\n    let a = h0, b = h1, c = h2, d = h3, e = h4, f = h5, g = h6, h = h7\n    for (let j = 0; j < 64; j++) {\n      const S1 = ((e >>> 6) | (e << 26)) ^ ((e >>> 11) | (e << 21)) ^ ((e >>> 25) | (e << 7))\n      const ch = (e & f) ^ (~e & g)\n      const temp1 = (h + S1 + ch + K[j] + w[j]) >>> 0\n      const S0 = ((a >>> 2) | (a << 30)) ^ ((a >>> 13) | (a << 19)) ^ ((a >>> 22) | (a << 10))\n      const maj = (a & b) ^ (a & c) ^ (b & c)\n      const temp2 = (S0 + maj) >>> 0\n      h = g; g = f; f = e; e = (d + temp1) >>> 0\n      d = c; c = b; b = a; a = (temp1 + temp2) >>> 0\n    }\n    h0 = (h0 + a) >>> 0; h1 = (h1 + b) >>> 0; h2 = (h2 + c) >>> 0; h3 = (h3 + d) >>> 0\n    h4 = (h4 + e) >>> 0; h5 = (h5 + f) >>> 0; h6 = (h6 + g) >>> 0; h7 = (h7 + h) >>> 0\n  }\n  return [h0, h1, h2, h3, h4, h5, h6, h7].map(v => v.toString(16).padStart(8, '0')).join('')\n}\n\n// 逐位计算 leading zero bits（与后端一致）\nfunction countLeadingZeroBits(hexHash: string): number {\n  let bits = 0\n  for (const char of hexHash) {\n    const nibble = parseInt(char, 16)\n    if (nibble === 0) {\n      bits += 4\n    } else {\n      if (nibble < 8) bits += 1\n      if (nibble < 4) bits += 1\n      if (nibble < 2) bits += 1\n      break\n    }\n  }\n  return bits\n}\n\n// JS 回退 PoW 求解（按位计数，与后端一致）\nfunction solvePoWJS(challenge: string, difficulty: number, startNonce: number, batchSize: number): string {\n  for (let i = 0; i < batchSize; i++) {\n    const nonce = startNonce + i\n    const nonceHex = nonce.toString(16)\n    const hash = sha256JS(challenge + nonceHex)\n    if (countLeadingZeroBits(hash) >= difficulty) {\n      return nonceHex\n    }\n  }\n  return ''\n}\n\n// 消息处理\nself.onmessage = async (e: MessageEvent) => {\n  const { type, data } = e.data\n\n  if (type === 'init') {\n    workerId = data.workerId\n    const basePath = data.basePath // 接收basePath参数\n    const hasWasm = await initWasm(basePath)\n    self.postMessage({ type: 'ready', workerId, hasWasm })\n    return\n  }\n\n  if (type === 'solve') {\n    const { challenge, difficulty, startNonce, batchSize, taskId } = data\n    const start = performance.now()\n\n    let nonce = ''\n\n    if (initialized && wasmModule) {\n      // 使用 WASM\n      try {\n        nonce = wasmModule.solve_pow_batch(challenge, difficulty, startNonce, batchSize)\n      } catch (e) {\n        console.warn(`[Worker ${workerId}] WASM 执行失败,回退 JS:`, e)\n        nonce = solvePoWJS(challenge, difficulty, startNonce, batchSize)\n      }\n    } else {\n      // JS 回退\n      nonce = solvePoWJS(challenge, difficulty, startNonce, batchSize)\n    }\n\n    self.postMessage({\n      type: 'result',\n      workerId,\n      taskId,\n      nonce,\n      found: nonce !== '',\n      elapsed: performance.now() - start,\n      searchedCount: batchSize,\n      usedWasm: initialized,\n    })\n  }\n}\n"],"names":["initialized","workerId","wasmModule","getWasmPath","basePath","base","initWasm","wasmModuleJs","wasmPath","e","K","sha256JS","str","utf8","len","padLen","totalLen","msg","view","h0","h1","h2","h3","h4","h5","h6","h7","w","i","j","s0","s1","a","b","c","d","f","g","h","S1","ch","temp1","S0","maj","temp2","v","countLeadingZeroBits","hexHash","bits","char","nibble","solvePoWJS","challenge","difficulty","startNonce","batchSize","nonceHex","hash","type","data","hasWasm","taskId","start","nonce"],"mappings":"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"}